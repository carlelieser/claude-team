{"version":3,"file":"approvals.svelte.js","sources":["../../../../src/lib/stores/approvals.svelte.ts"],"sourcesContent":["/**\n * Approval store using Svelte 5 runes\n */\n\nimport {\n  ipc,\n  type ApprovalDto,\n  type ApprovalFilterDto,\n  type ApprovalStatus,\n} from '$lib/ipc/client';\n\nclass ApprovalStore {\n  approvals = $state<ApprovalDto[]>([]);\n  loading = $state(false);\n  error = $state<string | null>(null);\n  filter = $state<ApprovalFilterDto>({ status: 'pending' });\n  count = $state(0);\n\n  pendingApprovals = $derived(\n    this.approvals.filter((a) => a.approvalStatus === 'pending')\n  );\n  approvedApprovals = $derived(\n    this.approvals.filter((a) => a.approvalStatus === 'approved')\n  );\n  rejectedApprovals = $derived(\n    this.approvals.filter((a) => a.approvalStatus === 'rejected')\n  );\n\n  private _unsubscribeUpdated: (() => void) | null = null;\n  private _unsubscribeRequired: (() => void) | null = null;\n\n  async load(filter?: ApprovalFilterDto): Promise<void> {\n    this.loading = true;\n    this.error = null;\n\n    if (filter) {\n      this.filter = filter;\n    }\n\n    try {\n      const result = await ipc.approval.list(this.filter);\n\n      if (result.ok) {\n        this.approvals = [...result.value];\n      } else {\n        this.error = result.error.message;\n      }\n\n      await this.refreshCount();\n    } catch (e) {\n      this.error = e instanceof Error ? e.message : 'Unknown error';\n    } finally {\n      this.loading = false;\n    }\n  }\n\n  async refreshCount(projectId?: string): Promise<void> {\n    try {\n      const result = await ipc.approval.count(projectId);\n\n      if (result.ok) {\n        this.count = result.value;\n      }\n    } catch (e) {\n      console.error('Failed to refresh approval count:', e);\n    }\n  }\n\n  async approve(id: string): Promise<ApprovalDto | null> {\n    try {\n      const result = await ipc.approval.approve(id);\n\n      if (result.ok) {\n        this.updateApprovalInList(result.value);\n        await this.refreshCount();\n        return result.value;\n      } else {\n        this.error = result.error.message;\n        return null;\n      }\n    } catch (e) {\n      this.error = e instanceof Error ? e.message : 'Unknown error';\n      return null;\n    }\n  }\n\n  async reject(id: string, reason?: string): Promise<ApprovalDto | null> {\n    try {\n      const result = await ipc.approval.reject(id, reason);\n\n      if (result.ok) {\n        this.updateApprovalInList(result.value);\n        await this.refreshCount();\n        return result.value;\n      } else {\n        this.error = result.error.message;\n        return null;\n      }\n    } catch (e) {\n      this.error = e instanceof Error ? e.message : 'Unknown error';\n      return null;\n    }\n  }\n\n  setFilter(filter: ApprovalFilterDto): void {\n    this.filter = filter;\n    this.load();\n  }\n\n  subscribe(): void {\n    this._unsubscribeUpdated = ipc.on.approvalUpdated((approval: ApprovalDto) => {\n      this.updateApprovalInList(approval);\n    });\n\n    this._unsubscribeRequired = ipc.on.approvalRequired(() => {\n      this.load();\n      this.refreshCount();\n    });\n  }\n\n  unsubscribe(): void {\n    if (this._unsubscribeUpdated) {\n      this._unsubscribeUpdated();\n      this._unsubscribeUpdated = null;\n    }\n    if (this._unsubscribeRequired) {\n      this._unsubscribeRequired();\n      this._unsubscribeRequired = null;\n    }\n  }\n\n  getById(id: string): ApprovalDto | undefined {\n    return this.approvals.find((a) => a.id === id);\n  }\n\n  getByStatus(status: ApprovalStatus): ApprovalDto[] {\n    return this.approvals.filter((a) => a.approvalStatus === status);\n  }\n\n  private updateApprovalInList(approval: ApprovalDto): void {\n    const index = this.approvals.findIndex((a) => a.id === approval.id);\n    if (index !== -1) {\n      this.approvals[index] = approval;\n    } else {\n      this.approvals = [...this.approvals, approval];\n    }\n  }\n}\n\nexport const approvalStore = new ApprovalStore();\n"],"names":[],"mappings":"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"}